version: '3.8'

services:
  app:
    container_name: fishing-api
    build:
      context: ./
      dockerfile: ./docker/go/Dockerfile
    ports:
      - "80:8000"
    env_file:
      - .env
    volumes:
      - .:/app
      - go-cache:/root/.cache/go-build
      - go-mod:/go/pkg/mod
    networks:
      -  common_network

  mysql:
    container_name: fishing-db
    build:
      context: ./
      dockerfile: ./docker/mysql/Dockerfile
    volumes:
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./docker/mysql/data:/var/lib/mysql
    tmpfs:
      - /var/log/mysql
    environment:
      - MYSQL_USER=user
      - MYSQL_PASSWORD=passpw
      - MYSQL_DATABASE=story_fishing_db
      - MYSQL_ROOT_PASSWORD=rootpw
    env_file:
      - .env
    ports:
      - "13306:3306"
    networks:
      - common_network

  migrator:
    container_name: fishing-mg
    image: migrate/migrate
    volumes:
      - ./app/infrastructure/database/migrations:/migrations
    depends_on:
      - mysql
    # TODO 直書き直す
    command: ["-path", "/migrations", "-database", "mysql://root:rootpw@tcp(fishing-DB:3306)/story_fishing_db", "up"]
    networks:
      - common_network

volumes:
  go-cache:
  go-mod:

networks:
  common_network:
