version: '3.8'

services:
  app:
    container_name: fishing-api
    build:
      context: ./
      dockerfile: ./docker/go/Dockerfile
    ports:
      - "80:80"
    env_file:
      - .env
    volumes:
      - .:/app
      - go-cache:/root/.cache/go-build
      - go-mod:/go/pkg/mod
    networks:
      -  common_network

  mysql:
    container_name: fishing-db
    build:
      context: ./
      dockerfile: ./docker/mysql/Dockerfile
    volumes:
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./docker/mysql/data:/var/lib/mysql
    tmpfs:
      - /var/log/mysql
    environment:
      - DB_USER=user
      - DB_PASS=passpw
      - DB_DATABASE=story_fishing_db
      - DB_ROOT_PASS=rootpw
    env_file:
      - .env
    ports:
      - "13306:3306"
    networks:
      - common_network

  # migrator:
  #   container_name: fishing-mg
  #   image: migrate/migrate
  #   volumes:
  #     - ./app/infrastructure/database/migrations:/migrations
  #   depends_on:
  #     - mysql
  #   command: ["-path", "/migrations", "-database", "mysql://root:rootpw@tcp(fishing-DB:3306)/story_fishing_db", "up"]
  #   # command: ["-path", "/migrations", "-database", "mysql://admin:p0w5yHv3L6RAOjve4E3P@tcp(fishing-db-cluster.cluster-cmy9wzweaztg.ap-northeast-1.rds.amazonaws.com:3306)/story_fishing_db", "up"]
  #   env_file:
  #     - .env
  #   networks:
  #     - common_network

volumes:
  go-cache:
  go-mod:

networks:
  common_network:
